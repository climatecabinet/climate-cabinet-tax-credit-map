version: "3"

services:

  app:
    build:
      context: ../pipeline
      dockerfile: ../tests/unittest.Dockerfile
    container_name: test-app
    env_file:
      - ../tests/unittest.env
    environment:
      - POSTGRES_HOST=db
    volumes:
      - ../pipeline:/pipeline
      - /pipeline/tax_credit/migrations
    command: ["tail", "-f", "/dev/null"]
    depends_on:
      db:
        condition: service_healthy
  
  db:
    image: postgis/postgis:13-3.3
    environment:
      - POSTGRES_DB=postgres_db
      - POSTGRES_USER=postgres_user
      - POSTGRES_PASSWORD=postgres_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -q -d postgres_db -U postgres_user && echo 'select 1' | psql -d postgres_db -U postgres_user"]
      interval: 2s
      timeout: 10s
      retries: 5
      start_period: 15s
